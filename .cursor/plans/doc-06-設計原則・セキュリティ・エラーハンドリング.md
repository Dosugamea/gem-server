---
name: タスク06 - 設計原則・セキュリティ・エラーハンドリング
overview: 設計原則、セキュリティ、エラーハンドリングを定義します
---

# タスク06: 設計原則・セキュリティ・エラーハンドリング

## 6. 設計原則

### 6.1 完結型API

各APIは単一のリクエストで完結し、複数のAPI呼び出しを必要としない。

### 6.2 わりきった冪等性

- トランザクションIDによる冪等性保証
- 同じトランザクションIDでの重複リクエストは既存結果を返却

### 6.3 完全なログと過去状態遡及

- 全トランザクションを履歴テーブルに記録
- 任意の時点の残高を再計算可能
- 監査ログとして機能

### 6.4 購入毎の管理の分離

- 各PaymentRequestを独立したレコードとして管理
- 決済処理と通貨付与を分離

### 6.5 マイナス残高の考慮

- **マイナス残高の許可**: 運用によってはマイナス残高が発生する可能性があります
                                - 返金処理: 既に消費済みの通貨を返金する際、残高が0未満になる場合がある
                                - 補填処理: 問題があった際の補填で、既に消費された通貨を補填する場合
                                - 手動調整: 運用上の理由で手動で残高を調整する場合
                                - 失効処理: アカウントBANなどで通貨を失効させる際、既に消費済みの場合はマイナスになる可能性がある
- **マイナス残高の管理**:
                                - マイナス残高が発生した場合は、必ずトランザクション履歴に記録する
                                - マイナス残高の発生を監視し、アラートを設定する
                                - マイナス残高の許容範囲や上限を設定する（必要に応じて）
                                - マイナス残高の解消方法を明確にする（例：次回の付与時に自動的に相殺）

## 7. セキュリティ

### 7.1 認証・認可

- JWT トークンベース認証
- ユーザーIDの検証
- レート制限（Rate Limiting）

### 7.2 データ整合性

- データベーストランザクションによる整合性保証
- 楽観的ロック（versionカラム）による同時更新制御
- 二重決済防止（PaymentRequest IDの一意性）

### 7.3 監査

- 全操作のログ記録
- 不正検知のための異常パターン監視

## 8. エラーハンドリング

### 8.1 エラーコード体系

- `INSUFFICIENT_BALANCE`: 残高不足
- `INVALID_AMOUNT`: 無効な金額
- `DUPLICATE_TRANSACTION`: 重複トランザクション
- `PAYMENT_REQUEST_NOT_FOUND`: PaymentRequestが見つからない
- `PAYMENT_REQUEST_ALREADY_PROCESSED`: 既に処理済み
- `CODE_NOT_FOUND`: 引き換えコードが見つからない
- `CODE_EXPIRED`: 引き換えコードが期限切れ
- `CODE_ALREADY_USED`: 引き換えコードが既に使用済み
- `CODE_DISABLED`: 引き換えコードが無効化されている
- `CODE_MAX_USES_REACHED`: 引き換えコードの使用上限に達している
- `USER_ALREADY_REDEEMED`: ユーザーが既にこのコードを引き換え済み
- `INTERNAL_ERROR`: 内部エラー

### 8.2 リトライ戦略

- 冪等性を保証することで、安全にリトライ可能
- 指数バックオフによるリトライ間隔制御
