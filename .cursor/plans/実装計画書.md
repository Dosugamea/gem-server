# 仮想通貨管理サービス 実装計画書

## 概要

本ドキュメントは、PaymentRequest APIプロバイダーとして機能する仮想通貨管理サービスを完成させるまでのステップバイステップの実装計画を記載します。

## 実装フェーズ

### フェーズ1: プロジェクト基盤のセットアップ

#### ステップ1.1: プロジェクト構造の作成
- [x] Go モジュールの初期化 (`go mod init`)
- [x] ディレクトリ構造の作成（internal/domain, internal/application, internal/infrastructure, internal/presentation）
- [x] `.gitignore` の設定
- [x] `README.md` の作成
- [x] `Makefile` またはビルドスクリプトの作成

#### ステップ1.2: 依存パッケージの導入
- [x] Echo Framework の導入
- [x] gRPC関連パッケージの導入
- [x] MySQLドライバーの導入
- [x] Redisクライアントの導入
- [x] OpenTelemetry関連パッケージの導入
- [x] JWT認証ライブラリの導入
- [x] その他必要なパッケージの導入

#### ステップ1.3: 設定管理の実装
- [x] 設定ファイル構造の定義（環境変数、設定ファイル）
- [x] 設定読み込み機能の実装（`infrastructure/config/config.go`）
- [x] 環境別設定ファイルの作成（開発、ステージング、本番）

---

### フェーズ2: データベース設計とマイグレーション

#### ステップ2.1: データベーススキーマの定義
- [x] `users` テーブルの作成
- [x] `currency_balances` テーブルの作成
- [x] `transactions` テーブルの作成
- [x] `payment_requests` テーブルの作成
- [x] `redemption_codes` テーブルの作成
- [x] `code_redemptions` テーブルの作成
- [x] インデックスの作成
- [x] 外部キー制約の設定

#### ステップ2.2: マイグレーションスクリプトの作成
- [x] マイグレーションツールの選定・導入（例: golang-migrate）
- [x] 初期マイグレーションファイルの作成
- [x] マイグレーション実行スクリプトの作成

#### ステップ2.3: データベース接続の実装
- [x] MySQL接続プールの実装
- [x] 接続設定の実装
- [x] ヘルスチェック機能の実装

---

### フェーズ3: ドメイン層の実装

#### ステップ3.1: 値オブジェクトの実装
- [x] `domain/currency/currency_type.go` - CurrencyType値オブジェクト
- [x] `domain/transaction/transaction_type.go` - TransactionType値オブジェクト
- [x] `domain/transaction/transaction_status.go` - TransactionStatus値オブジェクト
- [x] `domain/redemption_code/code_type.go` - CodeType値オブジェクト
- [x] `domain/redemption_code/code_status.go` - CodeStatus値オブジェクト

#### ステップ3.2: エンティティの実装
- [x] `domain/currency/currency.go` - Currencyエンティティ
  - [x] Grant メソッドの実装
  - [x] Consume メソッドの実装（マイナス残高対応）
  - [x] バリデーションロジック
- [x] `domain/transaction/transaction.go` - Transactionエンティティ
- [x] `domain/payment_request/payment_request.go` - PaymentRequestエンティティ
- [x] `domain/redemption_code/redemption_code.go` - RedemptionCodeエンティティ
  - [x] IsValid メソッドの実装
  - [x] CanBeRedeemed メソッドの実装
  - [x] Redeem メソッドの実装

#### ステップ3.3: ドメインエラーの定義
- [x] `domain/currency/errors.go` - 通貨関連エラー
- [x] `domain/transaction/errors.go` - トランザクション関連エラー
- [x] `domain/payment_request/errors.go` - PaymentRequest関連エラー
- [x] `domain/redemption_code/errors.go` - コード引き換え関連エラー

#### ステップ3.4: リポジトリインターフェースの定義
- [x] `domain/currency/repository.go` - CurrencyRepositoryインターフェース
- [x] `domain/transaction/repository.go` - TransactionRepositoryインターフェース
- [x] `domain/payment_request/repository.go` - PaymentRequestRepositoryインターフェース
- [x] `domain/redemption_code/repository.go` - RedemptionCodeRepositoryインターフェース

#### ステップ3.5: ドメインサービスの実装
- [x] `domain/service/currency_service.go` - 通貨関連のドメインサービス

---

### フェーズ4: インフラストラクチャ層の実装

#### ステップ4.1: MySQLリポジトリの実装
- [x] `infrastructure/persistence/mysql/currency_repository.go`
  - [x] FindByUserIDAndType メソッド
  - [x] Save メソッド（楽観的ロック対応）
  - [x] Create メソッド
- [x] `infrastructure/persistence/mysql/transaction_repository.go`
  - [x] Save メソッド
  - [x] FindByTransactionID メソッド
  - [x] FindByUserID メソッド（ページネーション対応）
- [x] `infrastructure/persistence/mysql/payment_request_repository.go`
  - [x] Save メソッド
  - [x] FindByPaymentRequestID メソッド
  - [x] Update メソッド
- [x] `infrastructure/persistence/mysql/redemption_code_repository.go`
  - [x] FindByCode メソッド
  - [x] Update メソッド
  - [x] HasUserRedeemed メソッド
  - [x] SaveRedemption メソッド

#### ステップ4.2: トランザクション管理の実装
- [x] `infrastructure/persistence/mysql/transaction_manager.go`
  - [x] WithTransaction メソッドの実装

#### ステップ4.3: Redisキャッシュの実装（オプション）
- [ ] Redis接続の実装
- [ ] キャッシュレイヤーの実装
- [ ] キャッシュ戦略の定義

#### ステップ4.4: OpenTelemetry統合の実装
- [x] `infrastructure/observability/otel/tracer.go` - トレーサーの初期化
- [x] `infrastructure/observability/otel/meter.go` - メーターの初期化
- [x] `infrastructure/observability/otel/logger.go` - 構造化ロガーの実装
- [x] `infrastructure/observability/otel/metrics.go` - メトリクス定義

---

### フェーズ5: アプリケーション層の実装

#### ステップ5.1: DTOの定義
- [x] `application/currency/dto.go` - 通貨関連DTO
  - [x] GrantRequest/GrantResponse
  - [x] ConsumeRequest/ConsumeResponse
  - [x] GetBalanceRequest/GetBalanceResponse
  - [x] ConsumptionDetail
- [x] `application/payment/dto.go` - 決済関連DTO
  - [x] ProcessPaymentRequest/ProcessPaymentResponse
  - [x] ConsumptionDetail
- [x] `application/history/dto.go` - 履歴関連DTO
  - [x] GetTransactionHistoryRequest/GetTransactionHistoryResponse
- [x] `application/code_redemption/dto.go` - コード引き換え関連DTO
  - [x] RedeemCodeRequest/RedeemCodeResponse

#### ステップ5.2: CurrencyApplicationServiceの実装
- [x] `application/currency/service.go`
  - [x] GetBalance メソッド
  - [x] Grant メソッド（トランザクション管理、履歴記録）
  - [x] Consume メソッド（単一通貨タイプ消費）
  - [x] ConsumeWithPriority メソッド（無料通貨優先消費）
  - [x] バリデーションロジック
  - [x] OpenTelemetryトレーシング統合
  - [x] 楽観的ロックのリトライロジック（指数バックオフ）

#### ステップ5.3: PaymentApplicationServiceの実装
- [x] `application/payment/service.go`
  - [x] ProcessPayment メソッド（優先順位付き消費、PaymentRequest記録）
  - [x] 二重決済防止ロジック
  - [x] 冪等性保証（PaymentRequest IDによる）

#### ステップ5.4: CodeRedemptionApplicationServiceの実装
- [x] `application/code_redemption/service.go`
  - [x] Redeem メソッド（コード検証、通貨付与、履歴記録）
  - [x] トランザクション管理
  - [x] エラーハンドリング

#### ステップ5.5: HistoryApplicationServiceの実装
- [x] `application/history/service.go`
  - [x] GetTransactionHistory メソッド（ページネーション、フィルタリング）

---

### フェーズ6: プレゼンテーション層（REST API）の実装

#### ステップ6.1: OpenAPI仕様の作成
- [ ] `presentation/openapi/spec.yaml` の作成
  - [ ] 全エンドポイントの定義
  - [ ] スキーマ定義
  - [ ] エラーレスポンス定義

#### ステップ6.2: ミドルウェアの実装
- [ ] `presentation/rest/middleware/auth.go` - JWT認証ミドルウェア
- [ ] `presentation/rest/middleware/tracing.go` - トレーシングミドルウェア
- [ ] `presentation/rest/middleware/logging.go` - ログミドルウェア
- [ ] `presentation/rest/middleware/error_handler.go` - エラーハンドリングミドルウェア
- [ ] `presentation/rest/middleware/rate_limit.go` - レート制限ミドルウェア（オプション）

#### ステップ6.3: ハンドラーの実装
- [ ] `presentation/rest/handler/currency_handler.go`
  - [ ] GetBalance ハンドラー
  - [ ] GrantCurrency ハンドラー
  - [ ] ConsumeCurrency ハンドラー
- [ ] `presentation/rest/handler/payment_handler.go`
  - [ ] ProcessPayment ハンドラー
- [ ] `presentation/rest/handler/code_redemption_handler.go`
  - [ ] RedeemCode ハンドラー
- [ ] `presentation/rest/handler/history_handler.go`
  - [ ] GetTransactionHistory ハンドラー

#### ステップ6.4: ルーティング設定
- [ ] `presentation/rest/router.go` の実装
  - [ ] ルート定義
  - [ ] ミドルウェアの適用
  - [ ] OpenAPIバリデーションの統合

#### ステップ6.5: Swagger UI / ReDoc統合
- [ ] Swagger UI の設定
- [ ] ReDoc の設定
- [ ] OpenAPI仕様ファイルの配信設定

---

### フェーズ7: プレゼンテーション層（gRPC API）の実装

#### ステップ7.1: Protocol Buffers定義の作成
- [ ] `presentation/grpc/proto/currency.proto` の作成
  - [ ] サービス定義
  - [ ] メッセージ定義

#### ステップ7.2: gRPCコード生成
- [ ] `protoc` によるコード生成
- [ ] 生成されたコードの確認

#### ステップ7.3: gRPCハンドラーの実装
- [ ] `presentation/grpc/handler/currency_handler.go` の実装
  - [ ] 全RPCメソッドの実装
  - [ ] エラーハンドリング
  - [ ] OpenTelemetryトレーシング統合

#### ステップ7.4: gRPCサーバーの実装
- [ ] `presentation/grpc/server.go` の実装
  - [ ] サーバー起動処理
  - [ ] グレースフルシャットダウン

---

### フェーズ8: Payment Handlerの実装

#### ステップ8.1: Payment Method Manifestの作成
- [ ] `public/pay/payment-manifest.json` の作成
- [ ] HTTPヘッダーでの参照設定

#### ステップ8.2: Web App Manifestの作成
- [ ] `public/pay/manifest.json` の作成
- [ ] アイコンの準備

#### ステップ8.3: Service Workerの実装
- [ ] `public/pay/sw-payment-handler.js` の実装
  - [ ] `canmakepayment` イベントハンドラ
  - [ ] `paymentrequest` イベントハンドラ
  - [ ] 決済アプリウィンドウとの通信
  - [ ] PaymentResponseの生成

#### ステップ8.4: 決済アプリウィンドウの実装
- [ ] `public/pay/index.html` の作成
  - [ ] UIデザイン
  - [ ] レスポンシブ対応
- [ ] `public/pay/payment-app.js` の実装
  - [ ] ユーザー認証処理
  - [ ] 残高取得API呼び出し
  - [ ] 決済情報の表示
  - [ ] 決済承認/キャンセル処理
  - [ ] Service Workerとの通信

#### ステップ8.5: 静的ファイル配信の設定
- [ ] Echo Frameworkでの静的ファイル配信設定
- [ ] 適切なHTTPヘッダーの設定

---

### フェーズ9: 認証・認可の実装

#### ステップ9.1: JWT認証の実装
- [ ] JWTトークン生成機能の実装
- [ ] JWTトークン検証機能の実装
- [ ] トークンリフレッシュ機能の実装（オプション）

#### ステップ9.2: 認証ミドルウェアの統合
- [ ] REST APIへの認証ミドルウェア適用
- [ ] gRPCへの認証インターセプター適用
- [ ] Payment Handlerへの認証統合

#### ステップ9.3: 認可ロジックの実装
- [ ] ユーザーID検証ロジック
- [ ] 権限チェックロジック（必要に応じて）

---

### フェーズ10: 可観測性の実装

#### ステップ10.1: トレーシングの統合
- [ ] アプリケーション層へのトレーシング追加
- [ ] データベースクエリのトレーシング
- [ ] 外部API呼び出しのトレーシング

#### ステップ10.2: メトリクスの実装
- [ ] ビジネスメトリクスの定義
  - [ ] トランザクション数
  - [ ] 通貨残高の分布
  - [ ] マイナス残高の発生件数
- [ ] システムメトリクスの定義
  - [ ] リクエスト数
  - [ ] レスポンス時間
  - [ ] エラー率

#### ステップ10.3: ログの実装
- [ ] 構造化ログの実装
- [ ] ログレベルの設定
- [ ] トレースIDとの関連付け

#### ステップ10.4: 監視ダッシュボードの設定（オプション）
- [ ] Grafanaダッシュボードの作成
- [ ] アラート設定

---

### フェーズ11: テストの実装

#### ステップ11.1: 単体テストの実装
- [ ] ドメインエンティティのテスト
  - [ ] Currencyエンティティのテスト
  - [ ] RedemptionCodeエンティティのテスト
- [ ] アプリケーションサービスのテスト
  - [ ] CurrencyApplicationServiceのテスト
  - [ ] PaymentApplicationServiceのテスト
  - [ ] CodeRedemptionApplicationServiceのテスト
- [ ] リポジトリのテスト（モック使用）

#### ステップ11.2: 統合テストの実装
- [ ] REST APIエンドポイントのテスト
  - [ ] 各エンドポイントのテスト
  - [ ] エラーケースのテスト
- [ ] gRPC APIのテスト
- [ ] データベース統合テスト
  - [ ] トランザクション管理のテスト
  - [ ] 楽観的ロックのテスト

#### ステップ11.3: E2Eテストの実装
- [ ] PaymentRequest APIフローのテスト
  - [ ] Service Workerのテスト
  - [ ] 決済アプリウィンドウのテスト
  - [ ] マーチャントサイトからの決済リクエストのシミュレーション

#### ステップ11.4: テストカバレッジの確認
- [ ] カバレッジレポートの生成
- [ ] カバレッジ目標の設定

---

### フェーズ12: デプロイメント設定

#### ステップ12.1: Docker化
- [ ] `Dockerfile` の作成
- [ ] `.dockerignore` の作成
- [ ] マルチステージビルドの設定（オプション）

#### ステップ12.2: Docker Compose設定（開発環境用）
- [ ] `docker-compose.yml` の作成
  - [ ] アプリケーションサービス
  - [ ] MySQLサービス
  - [ ] Redisサービス（オプション）
  - [ ] Jaegerサービス（オプション）

#### ステップ12.3: CI/CDパイプラインの設定（オプション）
- [ ] GitHub Actions / GitLab CI などの設定
- [ ] 自動テスト実行
- [ ] 自動ビルド・デプロイ

#### ステップ12.4: 環境変数の管理
- [ ] 環境別設定ファイルの整理
- [ ] シークレット管理の設定

---

### フェーズ13: ドキュメント作成

#### ステップ13.1: APIドキュメント
- [ ] OpenAPI仕様の完成
- [ ] Swagger UI / ReDoc の動作確認
- [ ] API使用例の作成

#### ステップ13.2: 開発者向けドキュメント
- [ ] アーキテクチャドキュメント
- [ ] セットアップガイド
- [ ] 開発ガイドライン

#### ステップ13.3: 運用ドキュメント
- [ ] デプロイ手順書
- [ ] 監視・アラート設定ガイド
- [ ] トラブルシューティングガイド

---

### フェーズ14: 最終確認とリリース準備

#### ステップ14.1: コードレビュー
- [ ] コード品質の確認
- [ ] セキュリティチェック
- [ ] パフォーマンステスト

#### ステップ14.2: 負荷テスト（オプション）
- [ ] 負荷テストの実施
- [ ] ボトルネックの特定と改善

#### ステップ14.3: セキュリティ監査（オプション）
- [ ] セキュリティ脆弱性のチェック
- [ ] ペネトレーションテスト（必要に応じて）

#### ステップ14.4: リリース準備
- [ ] バージョンタグの設定
- [ ] リリースノートの作成
- [ ] 本番環境へのデプロイ計画

---

## 実装の優先順位

### 必須機能（MVP）
1. フェーズ1: プロジェクト基盤のセットアップ
2. フェーズ2: データベース設計とマイグレーション
3. フェーズ3: ドメイン層の実装
4. フェーズ4: インフラストラクチャ層の実装（MySQLリポジトリのみ）
5. フェーズ5: アプリケーション層の実装
6. フェーズ6: プレゼンテーション層（REST API）の実装
7. フェーズ8: Payment Handlerの実装（基本機能）
8. フェーズ9: 認証・認可の実装（基本機能）

### 重要機能
9. フェーズ7: プレゼンテーション層（gRPC API）の実装
10. フェーズ10: 可観測性の実装
11. フェーズ11: テストの実装

### 推奨機能
12. フェーズ4: Redisキャッシュの実装
13. フェーズ12: デプロイメント設定
14. フェーズ13: ドキュメント作成
15. フェーズ14: 最終確認とリリース準備

---

## 注意事項

### 実装時の注意点

1. **マイナス残高の対応**
   - Consumeメソッドでマイナス残高を許可するか、別メソッドを用意するか検討
   - マイナス残高発生時の監視・アラート設定

2. **楽観的ロック**
   - versionカラムを使用した同時更新制御の実装
   - 競合時のリトライロジック

3. **トランザクション管理**
   - データベーストランザクションの適切な使用
   - トランザクション境界の明確化

4. **冪等性保証**
   - トランザクションIDによる冪等性保証
   - 重複リクエストの検出と既存結果の返却

5. **エラーハンドリング**
   - 適切なエラーコードの返却
   - エラーログの記録
   - ユーザー向けエラーメッセージの定義

6. **セキュリティ**
   - JWTトークンの適切な検証
   - SQLインジェクション対策
   - XSS対策（Payment Handler）
   - CSRF対策

7. **パフォーマンス**
   - データベースクエリの最適化
   - インデックスの適切な使用
   - キャッシュの活用（必要に応じて）

---

## 実装チェックリスト

各フェーズの完了時に、以下の項目を確認してください：

- [ ] コードが仕様書に準拠しているか
- [ ] エラーハンドリングが適切に実装されているか
- [ ] ログが適切に記録されているか
- [ ] テストが実装されているか
- [ ] ドキュメントが更新されているか
- [ ] セキュリティチェックが完了しているか
- [ ] パフォーマンステストが実施されているか（必要に応じて）

---

## 参考資料

- 仮想通貨管理サービス仕様書（`.cursor/plans/仮想通貨管理サービス仕様書_53e01344.plan.md`）
- doc-01-システム概要.md
- doc-02-アーキテクチャ.md
- doc-03-データベース設計.md
- doc-04-API仕様.md
- doc-05-PaymentRequest-API-プロバイダー実装.md
- doc-06-設計原則・セキュリティ・エラーハンドリング.md
- doc-07-テスト戦略・デプロイメント.md
- doc-08-実装の詳細.md
- doc-09-今後の拡張.md
