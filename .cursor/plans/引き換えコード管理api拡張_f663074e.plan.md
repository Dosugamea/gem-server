---
name: 引き換えコード管理API拡張
overview: 引き換えコードの登録/削除/参照/一覧取得機能をadmin APIに追加します。既存のアーキテクチャパターンに従い、ドメイン層からプレゼンテーション層まで一貫して実装します。
todos:
  - id: "1"
    content: リポジトリインターフェースにCreate/Delete/FindAllメソッドを追加
    status: completed
  - id: "2"
    content: MySQLリポジトリにCreate/Delete/FindAllメソッドを実装
    status: completed
  - id: "3"
    content: アプリケーション層にDTO（CreateCode/DeleteCode/GetCode/ListCodes）を追加
    status: completed
  - id: "4"
    content: アプリケーションサービスにCreateCode/DeleteCode/GetCode/ListCodesメソッドを実装
    status: completed
  - id: "5"
    content: RESTハンドラーにCreateCode/DeleteCode/GetCode/ListCodesメソッドを追加
    status: completed
  - id: "6"
    content: ルーティングにadmin APIエンドポイントを追加
    status: completed
---

# 引き換えコード管理API拡張計画

## 概要

引き換えコードの管理機能をadmin APIに追加します。以下の4つの機能を実装します：

- **登録**: 新しい引き換えコードを作成
- **削除**: 既存の引き換えコードを削除（使用済みコードは削除不可）
- **参照**: 特定のコードの詳細を取得
- **一覧取得**: コードの一覧を取得（ページネーション対応）

## 実装範囲

### 1. ドメイン層の拡張

#### 1.1 リポジトリインターフェース拡張

**ファイル**: `internal/domain/redemption_code/repository.go`

以下のメソッドを`RedemptionCodeRepository`インターフェースに追加：

- `Create(ctx context.Context, code *RedemptionCode) error` - コードを作成
- `Delete(ctx context.Context, code string) error` - コードを削除
- `FindAll(ctx context.Context, limit, offset int) ([]*RedemptionCode, int, error)` - 一覧取得（総件数も返す）

**注意**: 削除時は`code_redemptions`テーブルに外部キー制約があるため、既に使用されているコードは削除できません。エラーハンドリングが必要です。

### 2. インフラストラクチャ層の拡張

#### 2.1 MySQLリポジトリ実装拡張

**ファイル**: `internal/infrastructure/persistence/mysql/redemption_code_repository.go`

以下のメソッドを実装：

- `Create`: INSERT文でコードを登録（metadataはJSONとして保存）
- `Delete`: DELETE文でコードを削除（外部キー制約エラーを適切に処理）
- `FindAll`: SELECT文で一覧取得とCOUNT文で総件数取得（ページネーション対応）

**実装パターン**: 既存の`FindByCode`や`Update`メソッドと同様に、OpenTelemetryトレーシングを統合します。

### 3. アプリケーション層の拡張

#### 3.1 DTO定義追加

**ファイル**: `internal/application/code_redemption/dto.go`

以下のDTOを追加：

- `CreateCodeRequest`: code, code_type, currency_type, amount, max_uses, valid_from, valid_until, metadata
- `CreateCodeResponse`: code, code_type, currency_type, amount, max_uses, current_uses, valid_from, valid_until, status, metadata, created_at
- `DeleteCodeRequest`: code
- `DeleteCodeResponse`: code, deleted_at
- `GetCodeRequest`: code
- `GetCodeResponse`: code, code_type, currency_type, amount, max_uses, current_uses, valid_from, valid_until, status, metadata, created_at, updated_at
- `ListCodesRequest`: limit, offset, status (optional), code_type (optional)
- `ListCodesResponse`: codes ([]*RedemptionCode), total, limit, offset

#### 3.2 アプリケーションサービス拡張

**ファイル**: `internal/application/code_redemption/service.go`

以下のメソッドを`CodeRedemptionApplicationService`に追加：

- `CreateCode(ctx context.Context, req *CreateCodeRequest) (*CreateCodeResponse, error)`
  - バリデーション（コードの重複チェック、日付の妥当性チェックなど）
  - ドメインエンティティの作成
  - リポジトリへの保存
- `DeleteCode(ctx context.Context, req *DeleteCodeRequest) (*DeleteCodeResponse, error)`
  - コードの存在確認
  - 使用済みチェック（code_redemptionsテーブルを確認）
  - 削除実行
- `GetCode(ctx context.Context, req *GetCodeRequest) (*GetCodeResponse, error)`
  - 既存の`FindByCode`を利用してコードを取得
- `ListCodes(ctx context.Context, req *ListCodesRequest) (*ListCodesResponse, error)`
  - ページネーションパラメータのバリデーション（limit: 1-100, offset: >=0）
  - フィルタリング（status, code_type）
  - リポジトリから一覧取得

**実装パターン**: 既存の`Redeem`メソッドと同様に、OpenTelemetryトレーシング、ログ、メトリクスを統合します。

### 4. プレゼンテーション層の拡張

#### 4.1 RESTハンドラー拡張

**ファイル**: `internal/presentation/rest/handler/code_redemption_handler.go`

以下のハンドラーメソッドを追加（すべてadmin API用）：

- `CreateCode(c echo.Context) error` - POST /admin/codes
- `DeleteCode(c echo.Context) error` - DELETE /admin/codes/:code
- `GetCode(c echo.Context) error` - GET /admin/codes/:code
- `ListCodes(c echo.Context) error` - GET /admin/codes

**実装パターン**: 既存の`CurrencyHandler`の`GrantCurrency`や`GetBalanceAdmin`と同様のパターンで実装します。

#### 4.2 ルーティング追加

**ファイル**: `internal/presentation/rest/router.go`

`setupRoutes`関数内の`adminAPI`グループに以下のルートを追加：

- `adminAPI.POST("/codes", redemptionHandler.CreateCode)`
- `adminAPI.DELETE("/codes/:code", redemptionHandler.DeleteCode)`
- `adminAPI.GET("/codes/:code", redemptionHandler.GetCode)`
- `adminAPI.GET("/codes", redemptionHandler.ListCodes)`

## エラーハンドリング

以下のエラーケースを適切に処理します：

- コード重複エラー（Create時）
- コード未存在エラー（Delete/Get時）
- 使用済みコード削除エラー（Delete時、外部キー制約違反）
- 無効なパラメータエラー（バリデーションエラー）
- データベースエラー

## データベース制約

`code_redemptions`テーブルに`FOREIGN KEY (code) REFERENCES redemption_codes(code) ON DELETE RESTRICT`制約があるため、既に使用されているコードは削除できません。削除前に使用状況をチェックし、適切なエラーメッセージを返します。

## テスト

既存のテストパターンに従い、以下を実装：

- リポジトリのユニットテスト
- アプリケーションサービスのユニットテスト
- ハンドラーの統合テスト（必要に応じて）

## API仕様

### POST /api/v1/admin/codes

引き換えコードを作成

**リクエストボディ**:

```json
{
  "code": "PROMO2024",
  "code_type": "promotion",
  "currency_type": "free",
  "amount": 1000,
  "max_uses": 100,
  "valid_from": "2024-01-01T00:00:00Z",
  "valid_until": "2024-12-31T23:59:59Z",
  "metadata": {"campaign_id": "campaign_001"}
}
```

### DELETE /api/v1/admin/codes/:code

引き換えコードを削除

### GET /api/v1/admin/codes/:code

引き換えコードの詳細を取得

### GET /api/v1/admin/codes?limit=50&offset=0&status=active&code_type=promotion

引き換えコードの一覧を取得（ページネーション・フィルタリング対応）