version: "3.9"

name: gem-server

services:
  # MySQLデータベース
  mysql:
    image: mysql:8.0
    container_name: gem-server-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: gem_db
      MYSQL_USER: gem_user
      MYSQL_PASSWORD: gem_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-prootpassword",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gem-network

  # Redis（オプション）
  redis:
    image: redis:7-alpine
    container_name: gem-server-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - gem-network

  # Jaeger（オプション - トレーシング用）
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: gem-server-jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    networks:
      - gem-network

  # アプリケーション
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gem-server-app
    environment:
      # サーバー設定
      ENVIRONMENT: development
      SERVER_PORT: 8080
      SERVER_READ_TIMEOUT: 15s
      SERVER_Write_TIMEOUT: 15s
      SERVER_IDLE_TIMEOUT: 60s

      # データベース設定
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: gem_user
      DB_PASSWORD: gem_password
      DB_NAME: gem_db
      DB_MAX_OPEN_CONNS: 25
      DB_MAX_IDLE_CONNS: 5
      DB_CONN_MAX_LIFETIME: 5m
      DB_CONN_MAX_IDLE_TIME: 10m

      # JWT設定
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      JWT_EXPIRATION: 24h
      JWT_ISSUER: gem-server

      # Redis設定（オプション）
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      REDIS_DB: 0
      REDIS_ENABLED: false

      # OpenTelemetry設定
      OTEL_ENABLED: true
      OTEL_SERVICE_NAME: gem-server
      OTEL_SERVICE_VERSION: 1.0.0
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4318
      OTEL_EXPORTER_OTLP_INSECURE: true
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
    ports:
      - "8080:8080"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      # マイグレーションファイルをマウント（開発用）
      - ./migrations:/app/migrations:ro
    networks:
      - gem-network
    command: >
      sh -c "
        echo 'Waiting for MySQL to be ready...' &&
        until nc -z mysql 3306; do sleep 1; done &&
        echo 'MySQL is ready!' &&
        echo 'Running migrations...' &&
        migrate -path /app/migrations -database 'mysql://gem_user:gem_password@tcp(mysql:3306)/gem_db?multiStatements=true' up || echo 'Migration failed or already applied' &&
        echo 'Starting application...' &&
        ./gem-server
      "

volumes:
  mysql_data:
  redis_data:

networks:
  gem-network:
    driver: bridge
